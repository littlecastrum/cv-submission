<script src="https://www.gstatic.com/firebasejs/4.7.0/firebase.js"></script>

<style>
  .labels {
    width: 100%;
    display: block;
  }
  .inputs {
    width: 490px;
    height: 40px;
    margin-right: 20px;
    padding-left: 5px;
    font-size:0.8em;
    background: #F9F9F9;
    border: solid 1px #d7d7d7
  }
  .sqs-block-code {
    max-width: 100%;
    padding: 20px;
    width: 100%;
  }
  button[type=submit] {
  	border-radius: 300px;
    background: #232323;
    color: white;
    font-family: Raleway;
    font-weight: 400;
    font-style: normal;
    text-transform: none;
    letter-spacing: .5px;
    height: 42px;
    width: 120px;
    cursor: pointer;
  }
  button[type=submit]:hover {
    border-color: #8ABDD4;
    border-width: 2px;
  }
  button[type=submit]:disabled {
    background: #EFF0F1;
    color: black;
    cursor: wait;
  }
</style>

<form name="upload" id="upload" >
  <p>
    <label for="name" class="labels">Name *</label>
    <input type="text" id="firstname" name="firstname" placeholder="first name" class="inputs" required/>
    <input type="text" id="lastname" name="lastname" placeholder="last name" class="inputs" required/>
  </p>
  <p>
    <label for="name" class="labels">Email Address *</label>
    <input type="text" id="email" name="email" class="inputs" required/>
  </p>
  <p>
    <label for="phone" class="labels">Phone *</label>
    <input type="text" id="phone" name="phone" class="inputs" required/>
  </p> 
  <p>
    <label for="images" class="labels">Upload CV *</label>
    <input id="file" type="file" name="file" required/>
  </p>
  <p>
    <button type="submit" name="submit">Submit</button>  
  </p>
</form>
<div></div>

<script>
  const uid = () => '_' + Math.random().toString(36).substr(2, 9)
  const extractExt = (file) => (file.name).match(/\.[0-9a-z]+$/i)[0]
  const validForm = (objForm) => {
    const notEmptyInput = !Object.values(objForm).some((value) => value === "")
    const firstnameValid = /^[a-zA-Z ]+$/.test(objForm.firstname)
    const lastnameValid = /^[a-zA-Z ]+$/.test(objForm.lastname)
    const emailValid = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(objForm.email)
    const phoneValid = /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/im.test(objForm.phone)
    return ![notEmptyInput, firstnameValid, lastnameValid, emailValid, phoneValid].some((bool) => bool === false)
  }
  const validFile = (HTMLElement) => HTMLElement.files[0] ? HTMLElement.files[0] : false
  const setData = (inputs, filePromiseUrl) => Object.assign({}, inputs, {fileUrl: filePromiseUrl})
  const formToObj = (form) => ({    
    [form.firstname.name]: form.firstname.value,
    [form.lastname.name]: form.lastname.value,
    [form.email.name]: form.email.value,
    [form.phone.name]: form.phone.value
  })

  async function firebaseUpload (storageRef, dbRef, form, dir, file, inputs) {
    form.submit.disabled = true
    let storagePromise
    let dbPromise
    try {    
      storagePromise = await storageRef.child(dir + extractExt(file)).put(file)
      dbPromise = await dbRef.ref(dir).set(setData(inputs, storagePromise.downloadURL))
      form.reset()
      form.submit.disabled = false
      return true
    } catch(error) {
      console.log(error, storagePromise, dbPromise)
      return false
    }
  }

  const config = {
    apiKey: "AIzaSyB9PHbnBQaJrGtXo97DKcCbd3Wz8dcranE",
    authDomain: "cv-submission.firebaseapp.com",
    databaseURL: "https://cv-submission.firebaseio.com",
    projectId: "cv-submission",
    storageBucket: "cv-submission.appspot.com"
  }

  let app = firebase.initializeApp(config)
  let storageRef = app.storage().ref()
  let dbRef = app.database()     
  let form = document.getElementById("upload")

  form.addEventListener("submit", (event) => {
    event.preventDefault()
    let inputs = formToObj(form)
    let file = validFile(form.file)
    if (validForm(inputs) && file) {    
      firebaseUpload(storageRef, dbRef, form, `/applicant/${uid()}`, file, inputs)
    } else {
      console.log("not valid form")
    }
  })
</script>